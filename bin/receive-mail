#!/usr/bin/perl
#
# $Id$
#
# script to handle a mailed form and pipe it to $CRPATH
#

require "getopts.pl";
do Getopts("l:");

if ($#ARGV != -1) { die "Usage: receive-mail [-l language-iso-code]\n"; }

if ($opt_l eq 'fr') {
	$LANG="fr";
} else {
	$LANG="en";
}

# local configuration
require "/usr/local/dns-manager/conf/config";
require "$DNSLIB/requests.pl";

#
# Create a temporary request file
#
$REQFILE="$REQDIR/mail-$$";

$headers = 1;

open(WF, ">$REQFILE") || die "Cannot open $REQFILE: $!\n";
open(VF, "| $SENDMAIL -t") || die "Cannot start sendmail: $!\n";

$thdrs = "";

while (<STDIN>) {
	$thdrs .= $_;

	last unless $headers;
	chop;

	if (/^\s/)	{ $line .= $_; next; }
	if (/^$/)	{ $headers = 0; }

	$lline = $line; $line = $_;

	if ($lline =~ /^([A-Za-z0-9-]+):\s/) {
		$hd = $1;
		$hd =~ tr/A-Z/a-z/;
	} else {
		$hd = "";
	}

	if ($hd eq "from")		{ $from=substr($lline, 6); }
	elsif ($hd eq "reply-to")	{ $replyto=substr($lline, 10); }
	elsif ($hd eq "subject")	{ $subject=substr($lline, 9); }
}

if ($headers) {
	die "Premature end of mail.\n";
}

if ($replyto) {
	print VF $MAILHEADERS;
	print VF "To: $replyto\n";
	print WF "mr.: $replyto\n";
} elsif ($from) {
	$replyto = $from;
	print VF $MAILHEADERS;
	print VF "To: $from\n";
	print WF "mr.: $from\n";
} else {
	close(WF);
	unlink($REQFILE);
	die "Error: no identified sender.\n";
}

print WF $thdrs;

#
# Copy the mail body to WF, removing all leading garbage
# to account for quoted replies, etc.
#
while (<STDIN>) {
	s/^[^a-zA-Z0-9]*//;
	print WF;
}
close(WF);

#
# Try to process aknowledgement mails
#
local ($rqid) = &rq_extract($subject);
if ($rqid) {
  # A valid request id has been found in the Subject:
  if (!&rq_exists($rqid)) {
    # The request does not exist
    #
  } else {
    # The request exists: read it and check its state
    ($error, $replyto, $action, $domain, $lang, $state, $dns, $dbrecords)
	= &rq_get_info($rqid, "DNSADMIN");
    if ($state eq "WaitAck") {
      # Change its state to "Open" and notify the user
      &rq_set_state($rqid, "DNSADMIN", "Open");
    }

    unlink($REQFILE);
    close(VF);
    die "Error sending mail: $!\n" if $?;
    exit 0;
  }
}

open(CHECK, "$CRPATH -s -l$LANG < $REQFILE mail 2>&1 |") || die "Cannot start $CRPATH: $!\n";
while (<CHECK>) {
	print VF;
}
close(CHECK);
unlink($REQFILE) if $?;

close(VF);
die "Error sending mail: $!\n" if $?;
