#!/usr/bin/perl

# $Id$

# local configuration.
require "/usr/local/dns-manager/conf/config";

$LOCK_SH = 1;
$LOCK_EX = 2;
$LOCK_NB = 4;
$LOCK_UN = 8;

if ($#ARGV != 0) {
  die("Usage: viz zonefile\n");
}

$parent = $ARGV[0];
$parent =~ tr/a-z/A-Z/;

$zonefile="$ZONEDIR/$parent";
$zonelock="$ZONEDIR/$parent.lock";
$zonenew="$ZONEDIR/$parent.new";

$date=`date`; chop $date;

print "locking $zonefile...\n";
$oldum = umask 0;
open(LF, ">$zonelock") || die("Cannot open lockfile $zonelock: $!\n");
umask $oldum;   
flock(LF, $LOCK_EX) || die "flock lock: $!\n";

open(OZF, "$zonefile") || die "Cannot open $zonefile: $!\n";
open(NZF, "> $zonenew") || die "Cannot open $zonenew: $!\n";

print NZF ";! updated by ".$ENV{'USER'}.", ".$date."\n";
while(<OZF>) {
	print NZF;
}
close(OZF) || die "Error copying $zonefile: $!\n";
close(NZF) || die "Error copying $zonenew: $!\n";

$editor="vi";
if ($ENV{'EDITOR'}) {
	$editor=$ENV{'EDITOR'};
}

if (!system($editor, $zonenew)) {
	system("diff", "-u", $zonefile, $zonenew);
	rename($zonenew, $zonefile);
} else {
	print "Editor failed, removing temp file\n";
	unlink($zonenew);
}
