#!/usr/bin/perl
#
# $Id$
#
# Option -s is used by receive-mail and means we have to output a
# Subject: header with our request id.
#

require "getopts.pl";
do Getopts("l:s");

$ENV{PATH} = "/sbin:/bin:/usr/sbin:/usr/bin";

#$) = 1025;
#$> = 1025;

if ($#ARGV !=0) { die "Usage: check-request [-l language-iso-code] [-s] request-id.\n"; }

if ($opt_l) {
	$ENV{'ARLANG'}=$opt_l;
} else {
	$ENV{'ARLANG'}="en";
}

# local configuration
require "/usr/local/autoreg/conf/config";
require "$DNSCONF/msg-check";
require "$DNSCONF/msg-val";
require "$DNSLIB/auth.pl";
require "$DNSLIB/errors.pl";
require "$DNSLIB/md5.pl";
require "$DNSLIB/misc.pl";
require "$DNSLIB/requests.pl";
require "$DNSLIB/whois.pl";

&zauth_read;

$REQID=&rq_make_id($ARGV[0]);

$YMD=`date +%Y%m%d`; chop $YMD;
$date=`date`; chop $date;

local ($k)=0;
local ($onect)=0;
local ($v)="";
local ($domain)="";
local (@fqdn);
local (@ip);
local (@got);
local ($nums)=0;
local ($rectype)="NS";

$multi = 0;

while (<STDIN>) {
	chop;
	if (?^Domain Version Number:?) {
		$v = substr($_, index($_, ":") + 1);
		if ($v =~ /^\s*(\S+)\s*$/) { $v = $1 } else { $v = "" }
		if ($v ne "E1.0") {
			die $ERR_UNKFT;
		}
		$formatok=1;
	}
	if (?^mr\.: ?) {
		$replyto = substr($_, index($_, ":") + 1);
		if ($replyto =~ /^\s*(.*\S)\s*$/) {
			$replyto = $1
		} elsif ($replyto =~ /^\s*<.*\S>\s*$/) {
			$replyto = $1
		} else {
			$replyto = ""
		}
	}
	if (?^ln\.: ?) {
		$LANG = substr($_, index($_, ":") + 1);
		if ($LANG =~ /^\s*(.*\S)\s*$/) {
			$ENV{'ARLANG'} = $1;
		} else {
			$ENV{'ARLANG'} = "en";
		}
		do "$DNSCONF/msg-check";
	}
	next unless $formatok;

	$k = index($_, ":");
	if ($k && /^[a-z][0-9a-z]\./) {
		if ($multi) {
			$ref{$refid} = $line;
			$multi = 0;
		}
		$v = substr($_, $k+1);
		if ($v =~ /^\s*(.*\S)\s*$/) { $v = $1 } else { next }
		$refid = substr($_, 0, index($_, "."));
		if ($got{$refid} && $refid !~ /^[if]/) {
			&pr_error($ERR_TWICE, $refid);
		}
		$got{$refid} = 1;
	} elsif ($multi) {
		# Glue multiple lines together (for addresses)
		$v = $_;
		if ($v =~ /^\s*(.*\S)\s*$/) { $v = $1 } else { $v = "" }
		if ($v eq "") { next }
		$line .= "\n\t" . $v; next
	}

	if (/^rt\./) {
		$req = $v;
	} elsif (/^mr\./) {
		$replyto = $v;
	} elsif (/^pp\./ || /^[oat]a\./) {
		$line = $v;
		$multi = 1;
	} elsif (/^dm\./) {
		$domain = $v;
	} elsif (/^rr\./) {
		$rectype = $v;
	} elsif (/^om\./ || /^[at][hmte]\./ || /^[oat][cspn]\./) {
		$ref{$refid} = $v;
	} elsif (/^f([1-9])\./) {
		$fqdn[$1] = uc($v);
		$nums++;
	} elsif (/^i([1-9])\./) {
		$ip[$1] = $v;
	}
}

if ($multi) {
	$ref{$refid} = $line;
	$multi = 0;
}

if ($replyto !~ /^\S+@[A-Za-z0-9-]+(\.[A-Za-z0-9-]+)+$/) {
	die sprintf($ERR_BADRP, $replyto);
}

# Put the ID in the Subject: only when it's a valid request.
# This is to avoid confusing ourselves (and the user...) by trying
# to find a nonexistent request if he replies to the mail we are sending.

if (! $formatok ) {
	if ($opt_s) { print $MSG_TPSUB; };
	print $MSG_TMPLT;
	$| = 1; print;
	system "cat $DOMTEMP";
	exit 1;
}

if ($opt_s) { printf $MSG_RQSUB, $REQID; };

$req =~ tr/a-z/A-Z/;
$domain =~ tr/a-z/A-Z/;
if ($ref{"ah"}) { $ref{"ah"} =~ tr/a-z/A-Z/ }
if ($ref{"th"}) { $ref{"th"} =~ tr/a-z/A-Z/ }

&stoperrs;

print $MSG_BASCK;

if ($req !~ /[a-zA-Z +]/) {
	&pr_error($ERR_BADRT, $req);
}
if ($rectype =~ /[^a-zA-Z -]/) {
	&pr_error($ERR_BADRR, $rectype);
}

if (!$domain) {
	&pr_error($ERR_NODOM);
} else {
	while ($domain =~ /^\.(.*)/) { $domain = $1; }
	while ($domain =~ /(.*)\.$/) { $domain = $1; }

	if ($k = index($domain, '.')) {
		$parentdom = substr($domain, $k+1);
		$newdom = substr($domain, 0, $k);
	} else {
		$parentdom="";
		$newdom = $domain;
	}

	&checkname($domain);
}

if (!$req) { &pr_error($ERR_MISRQ); }
elsif ($req =~ /^N/i ) { $req = 'N'; }
elsif ($req =~ /^D/i ) { $req = 'D'; }
elsif ($req =~ /^Modify domain contacts/i ) { $req = 'MC'; }
elsif ($req =~ /^Modify domain servers/i ) { $req = 'MZ'; }
elsif ($req =~ /^M/i ) { $req = 'M'; }
else { &pr_error($ERR_BADRT, $req); }

if (!$rectype) { &pr_error($ERR_MISRC); }
elsif ($rectype =~ /^N/) { $rectype = 'NS' }
elsif ($rectype =~ /^M/) { $rectype = 'MX' }
elsif ($rectype =~ /^C/) { $rectype = 'CNAME' }
elsif ($rectype =~ /^W/) { $rectype = 'WMX' }
else { &pr_error($ERR_BADRR, $rectype); }

$makerr=1;
if (!@fqdn) {
	if ($req =~ /^N/ || $req eq 'MZ') {
		&pr_error($ERR_NOSRV);
	} else {
		$makerr=0;
	}
} else {
    if ($req eq 'N' || $req eq 'MZ' || $req eq 'M') {
	for ($i = 0; $i <= 6; $i++) {
	    if (defined($fqdn[$i])) { &checkname($fqdn[$i]); }
	}
    }
}

if ($nums < 2 && ($req =~ /^N/ || $req eq 'MZ') && $rectype eq 'NS') {
	&pr_error($ERR_ONENS);
}

&stoperrs;

if ($makerr && $do_checkns) {
  if ($rectype =~ /^N/) {
    open(CHECKNS, "|$CHECKNSPATH") || die "Cannot start check-ns: $!\n";

    print CHECKNS "$domain\n";

    for ($i = 0; $i <= 6; $i++) {
      if (defined($fqdn[$i])) {
        print CHECKNS $fqdn[$i];
        if ($ip[$i]) { print CHECKNS " $ip[$i]" }
        print CHECKNS "\n";
      }
    }
    close(CHECKNS);
    exit $? if ($?);
  } elsif ($rectype =~ /^C/) {
    if (system("$CHECKCNAMEPATH $fqdn[0] 2>&1")) {
      exit 1;
    }
  } else {
    for ($i = 0; $i <= 6; $i++) {
      if (defined($fqdn[$i])) {
        if (system("$CHECKMXPATH $fqdn[$i] 2>&1")) { $doexit=1; }
      }
    }
    if ($doexit) { exit }
  }
}

print $MSG_CNTCK;

$makewhois = 1;

if (!$ref{"ah"} && !$ref{"am"} && !$ref{"th"} && !$ref{"tm"}) {
	if ($req eq "N") {
		&pr_error($ERR_MISCT);
	} else {
		$makewhois=0
	}
}
if ($req eq 'MZ' && $makewhois) {
  &pr_error($ERR_NOCON);
  $makewhois=0;
}

if ($ref{"am"} && $ref{"am"} !~ /^[a-zA-Z \.-]*$/) {
	&pr_error($ERR_INVCH, $ref{"am"});
}
if ($ref{"am"} && $ref{"am"} !~ /^\S+\s+\S.*$/) {
	&pr_error($ERR_INVCN, $ref{"am"});
}
if ($ref{"tm"} && $ref{"tm"} !~ /^[a-zA-Z \.-]*$/) {
	&pr_error($ERR_INVCH, $ref{"tm"});
}
if ($ref{"tm"} && $ref{"tm"} !~ /^\S+\s+\S.*$/) {
	&pr_error($ERR_INVCN, $ref{"tm"});
}

if ($ref{"ah"} && $ref{"ah"} !~ /^[A-Z]+[0-9]*(-[A-Z]+)?$/) {
	&pr_error($ERR_BADNH, $ref{"ah"});
}
if ($ref{"th"} && $ref{"th"} !~ /^[A-Z]+[0-9]*(-[A-Z]+)?$/) {
	&pr_error($ERR_BADNH, $ref{"th"});
}
if ($ref{"ae"} && $ref{"ae"} !~ /^\S+@[A-Za-z0-9-]+(\.[A-Za-z0-9-]+)+$/) {
	&pr_error($ERR_BADEM, $ref{"ae"});
}
if ($ref{"te"} && $ref{"te"} !~ /^\S+@[A-Za-z0-9-]+(\.[A-Za-z0-9-]+)+$/) {
	&pr_error($ERR_BADEM, $ref{"te"});
}
if ($ref{"om"} && $ref{"om"} !~ /^\S+.*$/) {
	&pr_error($ERR_BDORG, $ref{"om"});
}

if ($ref{"at"} && $ref{"at"} !~ /^\+?[0-9 -]*$/) {
	&pr_error($ERR_BADPH, $ref{"at"});
}
if ($ref{"tt"} && $ref{"tt"} !~ /^\+?[0-9 -]*$/) {
	&pr_error($ERR_BADPH, $ref{"tt"});
}

if ($makewhois) {
	$onect=0;
	if (!$ref{"ah"} && !$ref{"am"}) {
	    if (!$ref{"th"} && !$ref{"tm"}) {
		    &pr_error($ERR_NOCTC);
	    } else {
		print $MSG_NOADM;
		foreach $i ('h', 'm', 'o', 'a', 'c', 's', 'p', 'n', 't', 'e') {
		    $ref{"a".$i} = $ref{"t".$i};
		}
		$onect=1;
	    }
	    &pr_error($ERR_NONAM) unless $ref{"am"};
	    &pr_error($ERR_NOEML) unless $ref{"ae"};
	} elsif (!$ref{"th"} && !$ref{"tm"}) {
	    print $MSG_NOTEC;
	    foreach $i ('h', 'm', 'o', 'a', 'c', 's', 'p', 'n', 't', 'e') {
		$ref{"t".$i} = $ref{"a".$i};
	    }
	    $onect=1;
	    &pr_error($ERR_NONAM) unless $ref{"am"};
	    &pr_error($ERR_NOEML) unless $ref{"ae"};
	} else {
	    &pr_error($ERR_NOANM) unless $ref{"am"};
	    &pr_error($ERR_NOAEM) unless $ref{"ae"};
	    &pr_error($ERR_NOTNM) unless $ref{"tm"};
	    &pr_error($ERR_NOTEM) unless $ref{"te"};
	    $onect=1;
	    foreach $i ('h', 'm') {
		if ($ref{"t".$i} ne $ref{"a".$i}) { $onect=0; break; }
	    }
	    if ($onect) {
		print $MSG_ONECT;
	    }
	}

	&pr_error($ERR_NOORG) unless $ref{"om"};
	#&pr_error($ERR_NOOAD) unless $ref{"oa"};

	if ($replyto ne $ref{"ae"} && $replyto ne $ref{"te"}) {
	    &pr_error($ERR_UREPL, $replyto);
	}
}

&stoperrs;

if ($makewhois) {
	printf $MSG_WHOIS, $domain;
	&whodata(STDOUT);
	&stoperrs;
}

if ($makerr) {
	printf $MSG_GENRC, $parentdom;
	if ($req eq 'MC') {
		&pr_error($ERR_NORR);
	}

	foreach $i (keys %ZAUTH) {
		if ($parentdom eq $i) {
			# direct subdomain
			$parentok = 1;
			last
		}
	}
	if (!$parentok) {
		&pr_error($ERR_NOPAR, $parentdom);
	}

	&valdata(STDOUT);

	#select(STDOUT); $| = 1; print ""; $| = 0;
	#select(STDERR); $| = 1; print ""; $| = 0;

	&stoperrs;

}

if ($req ne 'D' && !$makewhois && !$makerr) {
  &pr_error($ERR_EMPTY);
}

if ($req eq 'MZ' || $req eq 'D' || ($req eq 'M' && !$makewhois)) {
	my $cok = 0;
	foreach $i (&whois_email("whois.eu.org", $domain)) {
		if ($i eq $replyto) { $cok = 1; last; }
	}
	if (!$cok) { &pr_error($ERR_UREPL, $replyto); }
}

&stoperrs;

select(STDOUT); $| = 1; print ""; $| = 0;

my $azreq;
$azreq = $req;
if ($req =~ /^M/) { $azreq = 'M'; };
if ($req =~ /^N/) { $azreq = 'N'; };
if ($req =~ /^D/) { $azreq = 'D'; };

if (system("$AZPATH -c -a$azreq -t$rectype $domain 2>&1")) {
	exit 1;
}

if ($req eq 'M') {
  if ($makerr && !$makewhois) {
    $req = 'MZ';
  } elsif ($makewhois && !$makerr) {
    $req = 'MC';
  }
}

$vr = &rq_create($REQID, $replyto, $req, $domain, $ENV{'ARLANG'})
		|| die ("Cannot open $REQID: $!\n");

if ($makerr) {
	&valdata($vr);
}
if ($makewhois) {
	&rq_end_dns($REQID, $vr);
	&whodata($vr);
}
&rq_end_create($REQID, $vr);

&rq_set_attr($REQID, 'DNSADMIN',
	     "checkack", &md5_compute("$MD5SEED:$REQID:".time().":$$:"));

print $MSG_ENDCK;
print $MSG_RQOK1;

if ($opt_s) {
  # We're called from a mail request, put the acknowledge request directly
  # there (this will get sent by e-mail)
  printf $MSG_RQOKM, $MSG_ADDR, $REQID;
  print  $MSG_BYE;
} else {
  # Called from a Web form: don't disclose the request id on the Web
  # to ensure the e-mail address is not phoney. Send it by e-mail instead.

  printf $MSG_RQOK2, $replyto;

  open(SMU, "| $SENDMAIL -t") || die "Cannot start sendmail: $!\n";
  print  SMU "From: $MSG_ADDR\n";
  print  SMU "To: $replyto\n";
  printf SMU $MSG_RQSUB, $REQID;
  print  SMU $MSG_RQOK0;
  print  SMU $MSG_RQOK1;
  printf SMU $MSG_RQOKM, $MSG_ADDR, $REQID;
  print  SMU $MSG_BYE;
  print  SMU $MSG_RQOKR;
  print  SMU "\n";

  if ($req =~ /^M/) {
    printf SMU $MSG_RQM, $domain;
  } elsif ($req =~ /^N/) {
    printf SMU $MSG_RQN, $domain;
  } elsif ($req =~ /^D/) {
    printf SMU $MSG_RQD, $domain;
  }
  print SMU "\n";

  if ($makerr) {
    print SMU $MSG_RQOKD;
    &valdata(SMU);
    print  SMU "\n";
  }
  if ($makewhois) {
    print SMU $MSG_RQOKW;
    &whodata(SMU);
    print  SMU "\n";
  }

  close(SMU);
}
exit;

sub checkname {
        if ($_[0] =~ /[^-A-Za-z0-9.]/) {
            &pr_error($ERR_BADDM, $_[0]);
	    return;
	}
        if ($_[0] =~ /\.\./ || $_[0] =~ /^\./) {
            &pr_error($ERR_BADD0, $_[0]);
	    return;
	}
        if ($_[0] =~ /^[0-9\.]+$/) {
            &pr_error($ERR_BADDB, $_[0]);
	    return;
	}
        if ($_[0] =~ /^[^A-Za-z0-9]/ || $_[0] =~ /\.[^A-Za-z0-9]/) {
            &pr_error($ERR_BADDB, $_[0]);
	    return;
	}
        if ($_[0] =~ /[^A-Za-z0-9]\./ || $_[0] =~ /[^A-Za-z0-9]$/) {
            &pr_error($ERR_BADDE, $_[0]);
	    return;
	}
}

sub whodata_person {
	local ($hdl, $pfx) = ($_[0], $_[1]);
	print $hdl "person:  ", $ref{$pfx."m"}, "\n";
	print $hdl "nic-hdl: ", $ref{$pfx."h"}, "\n" if $ref{$pfx."h"};
	print $hdl "e-mail:  ", $ref{$pfx."e"}, "\n" if $ref{$pfx."e"};
	print $hdl "address: ", $ref{$pfx."a"}, "\n" if $ref{$pfx."a"};
	print $hdl "address: ", $ref{$pfx."p"}, "\n" if $ref{$pfx."p"};
	print $hdl "address: ", $ref{$pfx."c"}, "\n" if $ref{$pfx."c"};
	print $hdl "address: ", $ref{$pfx."s"}, "\n" if $ref{$pfx."s"};
	print $hdl "address: ", $ref{$pfx."n"}, "\n" if $ref{$pfx."n"};
	print $hdl "phone:   ", $ref{$pfx."t"}, "\n" if $ref{$pfx."t"};
	print $hdl "source:  $DBNAME\n";
	print $hdl "\n";
}

sub whodata_domain {
	local ($hdl, $pfx) = ($_[0], $_[1]);
	print $hdl "domain:  ", $domain, "\n";
	print $hdl "address: ", $ref{"om"}, "\n" if $ref{"om"};
	print $hdl "address: ", $ref{"oa"}, "\n" if $ref{"oa"};
	print $hdl "address: ", $ref{"op"}, "\n" if $ref{"op"};
	print $hdl "address: ", $ref{"oc"}, "\n" if $ref{"oc"};
	print $hdl "address: ", $ref{"os"}, "\n" if $ref{"os"};
	print $hdl "address: ", $ref{"on"}, "\n" if $ref{"on"};

	if ($ref{"am"}) {
	    if ($ref{"ah"}) {
		print $hdl "admin-c: ", $ref{"ah"}, "\n";
	    } else {
		print $hdl "admin-c: ", $ref{"am"}, "\n";
	    }
	}

	if ($ref{"tm"}) {
	    if ($ref{"th"}) {
		print $hdl "tech-c:  ", $ref{"th"}, "\n";
	    } else {
		print $hdl "tech-c:  ", $ref{"tm"}, "\n";
	    }
	}

	#print $hdl "mnt-by:  $MNTBY\n";
	print $hdl "mnt-by:  \n";
	print $hdl "source:  $DBNAME\n";
	print $hdl "\n";
}

sub whodata {
	local ($hdl) = $_[0];

	&whodata_domain($hdl);
	&whodata_person($hdl, "a");
	&whodata_person($hdl, "t") unless $onect;
}

sub tabify {
	local ($f1, $f2, $tabto) = ($_[0], $_[1], $_[2]);
	local ($chto) = 8+(length($f1) & ~7);
	local ($tab);

	$tab = "\t";
	while ($chto < $tabto) { $tab = $tab."\t"; $chto += 8; }
	return $f1.$tab.$f2
}

#
# output records for zone
#
sub valdata {
	local ($hdl) = $_[0];
	my $labeldone;

	if ($rectype =~ /^N/) {
	    for ($i=0; $i <= 6; $i++) {
		if (defined($fqdn[$i])) {
		    if (!$labeldone) {
			print $hdl &tabify($newdom, "IN NS\t$fqdn[$i].\n", 24);
			$labeldone = 1;
		    } else {
			print $hdl "\t\t\tIN NS\t$fqdn[$i].\n";
		    }
		}
	    }

	    for ($i=0; $i <= 6; $i++) {
		if (defined($ip[$i]) && &isasubdomain($fqdn[$i], $domain)) {
		    if ($ip[$i] !~ /:/) {
			print $hdl &tabify("$fqdn[$i].", "IN A\t$ip[$i]\n", 24);
		    } else {
			print $hdl &tabify("$fqdn[$i].", "IN AAAA\t$ip[$i]\n", 24);
		    }
		}
	    }
	} elsif ($rectype =~ /^M/) {
	    for ($i=0; $i <= 6; $i++) {
		$pri=$i * 10;
		if (!$labeldone) {
		    print $hdl &tabify($newdom, "IN MX\t 0 $fqdn[$i].\n", 24);
		    $labeldone = 1;
		} else {
		    print $hdl "\t\t\tIN MX\t$pri $fqdn[$i].\n";
		}
	    }
	} elsif ($rectype =~ /^C/) {
	    print $hdl &tabify($newdom, "IN CNAME\t$fqdn[1].\n", 24);
	} else {
	    for ($i=0; $i <= 6; $i++) {
		$pri=$i * 10;
		if (!$labeldone) {
		    print $hdl &tabify($newdom, "IN MX\t 0 $fqdn[$i].\n", 24);
		    $labeldone = 1;
		} else {
		    print $hdl "\t\t\tIN MX\t$pri $fqdn[$i].\n";
		}
	    }
	    $labeldone = 0;
	    for ($i=0; $i <= 6; $i++) {
		$pri=$i * 10;
		if (!$labeldone) {
		    print $hdl &tabify("*.$newdom", "IN MX\t 0 $fqdn[$i].\n", 24);
		    $labeldone = 1;
		} else {
		    print $hdl "\t\t\tIN MX\t$pri $fqdn[$i].\n";
		}
	    }
	}
}
