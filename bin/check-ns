#!/usr/local/bin/python
# $Id$
#

import getopt
import re
import socket
import sys


import autoreg.dns.check

def main():
  """Gets on stdin :
  1)    a domain name
  2)    lines giving, for each server, its fqdn and
        (optionally) its IP address.

        -- OR --

  Gets a domain name in argument then retrieves the NS list on the Internet.

  Then proceeds with SOAChecker.main().
  """
  errs = 0
  fqdnlist = []
  manualip = { }
  nat = { }

  try:
    optlist, args = getopt.getopt(sys.argv[1:], 'o:')
  except getopt.GetoptError, err:
    print str(err)
    return 2

  for opt, val in optlist:
    if opt == '-o':
      oldip, newip = val.split('=')
      for ip in oldip, newip:
        try:
          if ':' in ip:
            socket.inet_pton(socket.AF_INET6, ip)
          else:
            socket.inet_pton(socket.AF_INET, ip)
        except socket.error:
          print "Error: Invalid IP address", ip
          errs += 1
          ip = None
      if ip is not None:
        nat[oldip] = newip

  if len(args) == 1:
    domain = args[0]
  else:
    # Fetch domain from stdin
    domain = sys.stdin.readline()
    domain = domain[:-1]

  soac = autoreg.dns.check.SOAChecker(domain, manualip, nat)

  for ok, out in soac.main(file=sys.stdin):
    print out
    if not ok:
      errs += 1

  if errs:
    return 1
  return 0

if __name__ == "__main__":
  sys.exit(main())
